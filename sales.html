<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Operations Intelligence — ICHI-BOO</title>
  <link rel="stylesheet" href="css/main.css">
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
    .report-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    
    .ops-controls {
        background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;
        display: flex; gap: 20px; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .ops-controls input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }

    .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 4px solid #ddd; }
    .stat-card.red { border-bottom-color: #d32f2f; }
    .stat-card.green { border-bottom-color: #2e7d32; }
    .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
    .stat-value { font-size: 1.6rem; font-weight: 800; color: #333; margin-top: 5px; }

    .report-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
    h2 { margin-top: 0; font-size: 0.9rem; text-transform: uppercase; color: #777; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

    .comp-table { width: 100%; border-collapse: collapse; }
    .comp-table td { padding: 10px; border-bottom: 1px solid #f9f9f9; }
    .comp-table .label { font-weight: 600; color: #555; }
    .comp-table .value { text-align: right; font-family: monospace; font-weight: bold; }
    .comp-total { background: #fdf2f2; font-weight: 800; color: #d32f2f; }

    .recon-input-group { margin-bottom: 15px; }
    .recon-input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: bold; }
    .recon-input-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; }
    
    .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
    .btn-save { background: #2e7d32; color: white; }
    .btn-print { background: #333; color: white; }
    .btn-save:hover { background: #1b5e20; }

    @media print {
    /* Hide the entire website by default */
    body * { visibility: hidden; }

    /* Specifically show only the Audit Card and everything inside it */
    .audit-print-area, .audit-print-area * { visibility: visible; }

    /* Position the audit card and fix the width/cutting issue */
    .audit-print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 95%; /* Reduced from 100% to prevent cutting */
        margin: 0 auto;
        padding: 10px;
        box-shadow: none !important;
        border: none !important;
    }

    /* Ensure the table itself doesn't overflow the container */
    .audit-print-area table {
        width: 100%;
        table-layout: auto;
    }

    /* Prevent text from touching the very edge of the paper */
    .audit-print-area .value {
        padding-right: 15px !important; 
    }

    /* Hide the 'Print' button itself */
    .btn-print { display: none !important; }
}
  </style>
</head>
<body>

 <script>
  // Access control check
  const role = sessionStorage.getItem("userRole");
  
  // 1. If not logged in at all, go to login
  if (sessionStorage.getItem("userLogged") !== "yes") {
      window.location.href = "login.html";
  } 
  // 2. If role is NOT admin and NOT manager, show error and go to POS
  else if (role !== "admin" && role !== "manager") {
      alert("Access Denied: Managers or Admins only.");
      window.location.href = "pos.html"; // This is the line that does the redirect
  }
  
</script> 

<header class="topbar">
  <div class="brand-info">
    <img src="css/img/logo.png" alt="Logo" class="logo-image">
    <div>
      <span class="brand-title">ICHI-BOO Takoyaki</span>
      <span class="brand-sub">Management System</span>
    </div>
  </div>

  <div class="user-tag" style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.15); padding: 5px 15px; border-radius: 50px; border: 1px solid var(--accent-color);">
    <div style="text-align: right;">
        <small style="display: block; font-size: 0.65rem; color: var(--accent-color); text-transform: uppercase; font-weight: bold;">Current User</small>
        <span id="navUserName" style="color: white; font-weight: 600; font-size: 0.9rem;">---</span>
    </div>
    <span id="navUserRole" style="font-size: 0.7rem; background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold;">---</span>
  </div>

  <nav class="navlinks">
    <a href="dashboard.html">Dashboard</a> 
    <a href="pos.html">POS</a>
    <a href="inventory.html">Inventory</a>
    <a href="sales.html">Sales</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<script>
  // This script runs on every page to populate the User Tag from session storage
  document.addEventListener("DOMContentLoaded", () => {
      const name = sessionStorage.getItem("userName") || "Unknown";
      const role = sessionStorage.getItem("userRole") || "Staff";
      
      const navName = document.getElementById("navUserName");
      const navRole = document.getElementById("navUserRole");
      
      if(navName) navName.innerText = name;
      if(navRole) navRole.innerText = role;

      // Auto-highlight the active link based on the current page
      const currentFile = window.location.pathname.split("/").pop();
      document.querySelectorAll(".navlinks a").forEach(link => {
          if(link.getAttribute("href") === currentFile) {
              link.classList.add("active");
          }
      });
  });
</script>

<main class="report-container">
  
  <section class="ops-controls" style="flex-wrap: wrap;">
    <div style="display: flex; gap: 15px; align-items: flex-end;">
        <div>
            <label style="font-size: 0.8rem; font-weight: bold; color: #666;">START DATE:</label><br>
            <input type="date" id="startDatePicker">
        </div>
        <div>
            <label style="font-size: 0.8rem; font-weight: bold; color: #666;">END DATE:</label><br>
            <input type="date" id="endDatePicker">
        </div>
        <button class="btn-action" onclick="renderFullDashboard()" style="margin: 0; padding: 10px 20px; width: auto; background: var(--primary-color); color: white; border-radius: 5px;">
            Filter Report
        </button>
    </div>

    <div style="display: flex; gap: 10px; margin-left: 20px;">
        <button class="btn" onclick="setQuickDate('today')" style="padding: 8px 15px; background: #eee; border: 1px solid #ccc; font-size: 0.85rem;">Today</button>
        <button class="btn" onclick="setQuickDate('week')" style="padding: 8px 15px; background: #eee; border: 1px solid #ccc; font-size: 0.85rem;">This Week</button>
        <button class="btn" onclick="setQuickDate('month')" style="padding: 8px 15px; background: #eee; border: 1px solid #ccc; font-size: 0.85rem;">This Month</button>
    </div>

    <div style="flex-grow: 1; text-align: right;">
        <span id="selectedDateLabel" style="font-weight: 800; color: #d32f2f; font-size: 1.2rem;">Today</span>
    </div>
</section>

  <div class="summary-grid">
    <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div id="boxDailyTotal" class="stat-value">₱0.00</div>
    </div>
    <div class="stat-card green">
        <div class="stat-label">Net Profit</div>
        <div id="boxDailyProfit" class="stat-value">₱0.00</div>
    </div>
    <div class="stat-card" style="border-bottom: 4px solid #3498db;">
        <div class="stat-label">Total Cash Payments</div>
        <div id="boxTotalCash" class="stat-value" style="color: #3498db;">₱0.00</div>
    </div>
    <div class="stat-card" style="border-bottom: 4px solid #9b59b6;">
        <div class="stat-label">Total E-Wallet Payments</div>
        <div id="boxTotalEWallet" class="stat-value" style="color: #9b59b6;">₱0.00</div>
    </div>
</div>


  <div class="report-layout">
    <div class="left-col">
        <section class="card">
    <h2>Daily Expense Breakdown</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="expDesc" placeholder="Description (e.g. Ice)" style="flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <input type="number" id="expAmt" placeholder="Amount" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <button class="btn primary" onclick="addExpenseItem()">Add</button>
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 20px;">
        <thead>
            <tr style="border-bottom: 2px solid #eee; text-align: left;">
                <th style="padding: 10px 5px;">Item</th>
                <th style="padding: 10px 5px; text-align: right;">Amount</th>
                <th style="padding: 10px 5px;"></th>
            </tr>
        </thead>
        <tbody id="expenseListBody">
            </tbody>
    </table>

    <h2>Sales Reconciliation</h2>
    <div class="form-group">
    <label>Starting Cash (Float)</label>
    <input type="number" id="inputStartingCash" placeholder="0.00" oninput="calculateReconciliation()">
</div>

<div class="form-group">
    <label>Actual Cash in Drawer</label>
    <input type="number" id="inputActualCash" placeholder="0.00" oninput="calculateReconciliation()">
</div>
<div class="form-group">
    <label>E-Wallet Total (GCash/Maya)</label>
    <input type="number" id="inputEWallet" placeholder="0.00" oninput="calculateReconciliation()">
</div>
    
    <p id="saveStatus" style="font-size: 0.8rem; text-align: center; margin-top: 10px; font-weight: bold;"></p>
</section>

    <section class="card audit-print-area">
    <h2>Detailed Audit Computation</h2>
    <table class="comp-table">
        <tr><td class="label">Gross Sales</td><td id="calcGross" class="value">₱0.00</td></tr>
        
        <tr><td class="label">Total Cash Payments</td><td id="auditTotalCash" class="value">₱0.00</td></tr>
        <tr><td class="label">Total E-Wallet Payments</td><td id="auditTotalEWallet" class="value">₱0.00</td></tr>
        
        

        <tbody id="auditExpenseRows">
            <tr><td class="label">Less: Daily Expenses</td><td class="value">- ₱0.00</td></tr>
        </tbody>
<tr class="comp-total">
            <td class="label">Total Expected Cash on Hand</td>
            <td id="calcExpected" class="value">₱0.00</td>
        </tr>
        <tr>
            <td class="label">Cash Discrepancy (Short/Over)</td>
            <td id="calcVariance" class="value">₱0.00</td>
        </tr>
    </table>
    <button onclick="window.print()" class="btn-action btn-print">Print Audit Report</button>
</section>
    </div>

    <div class="right-col">
        <section class="card">
            <h2>Top Items for Selected Date</h2>
            <div id="topSellers"></div>
        </section>
        <section class="card">
            <h2>Transaction Log</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tbody id="salesHistory"></tbody>
            </table>
        </section>
    </div>
  </div>
</main>

<script src="js/database.js"></script>
<script src="js/sales.js"></script>
</body>
</html>
