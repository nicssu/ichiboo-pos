<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>Dashboard ‚Äî ICHI-BOO Takoyaki</title>
  <link rel="stylesheet" href="css/main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<script>
  if (sessionStorage.getItem("userLogged") !== "yes") {
      window.location.href = "login.html";
  }
</script>

<header class="topbar">
  <div class="brand-info">
    <img src="css/img/logo.png" alt="Logo" class="logo-image">
    <div>
      <span class="brand-title">ICHI-BOO Takoyaki</span>
      <span class="brand-sub">Management Dashboard</span>
    </div>
  </div>
  
  <div class="user-tag" style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--accent-color); display: flex; align-items: center; gap: 10px;">
    <div>
        <span style="font-size: 0.7rem; display: block; color: var(--accent-color); text-transform: uppercase;">Logged in:</span>
        <strong id="displayUserName" style="color: white;">---</strong> 
    </div>
    <span id="displayUserRole" style="font-size: 0.7rem; text-transform: uppercase; background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px;">---</span>
  </div>

  <nav class="navlinks">
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="pos.html">POS</a>
    <a href="inventory.html">Inventory</a>
    <a href="sales.html">Sales</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main class="dashboard-container">
  
  <section class="card" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; background: var(--primary-color); color: white; flex-wrap: wrap;">
    <h2 style="margin:0; font-size: 1.1rem; color: white; border: none;">Report Range:</h2>
    <input type="date" id="dashStart" style="padding: 6px; border-radius: 4px; border: none;">
    <span>to</span>
    <input type="date" id="dashEnd" style="padding: 6px; border-radius: 4px; border: none;">
    <button class="btn" onclick="refreshDashboardData()" style="background: var(--accent-color); color: white; border: none; padding: 7px 15px; font-weight: bold; cursor: pointer; border-radius: 4px;">Filter</button>
    
    <div style="display: flex; gap: 5px; margin-left: 10px;">
        <button class="btn" onclick="setDashQuickDate('today')" style="padding: 6px 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.75rem;">Today</button>
        <button class="btn" onclick="setDashQuickDate('week')" style="padding: 6px 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.75rem;">Week</button>
        <button class="btn" onclick="setDashQuickDate('month')" style="padding: 6px 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.75rem;">Month</button>
    </div>
</section>

  <div class="stats-grid">
    <div class="stat-card">
        <h3 id="salesLabel">Total Sales</h3>
        <div id="dashTotalSales" class="stat-value">‚Ç±0.00</div>
    </div>
    <div class="stat-card">
        <h3>Transactions</h3>
        <div id="dashTotalCount" class="stat-value">0</div>
    </div>
    <div class="stat-card profit">
        <h3>Stock Alerts</h3>
        <div id="dashStockAlertCount" class="stat-value">0</div>
        <p style="font-size: 0.8rem; color: #666;">Items below threshold</p>
    </div>
  </div>

  <section class="card" style="margin-bottom: 20px;">
    <h2>Sales Performance Trend</h2>
    <div style="height: 300px;">
        <canvas id="salesChart"></canvas>
    </div>
  </section>

  <div class="reports-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
    <section class="card">
      <h2>‚ö†Ô∏è Low Stock Warning</h2>
      <div style="max-height: 250px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 2px solid var(--background-light); position: sticky; top: 0; background: white;">
                    <th style="padding: 10px;">Item</th>
                    <th>Qty</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="lowStockTable"></tbody>
          </table>
      </div>
    </section>

    <section class="card">
      <h2>‚è∞ Expiry Alerts</h2>
      <div style="max-height: 250px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 2px solid var(--background-light); position: sticky; top: 0; background: white;">
                    <th style="padding: 10px;">Raw Material</th>
                    <th>Expiry</th>
                    <th>Alert</th>
                </tr>
            </thead>
            <tbody id="dashExpiryTable"></tbody>
          </table>
      </div>
    </section>

    <section class="card">
  <h2>System Quick Links</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
      <button class="btn primary" onclick="location.href='pos.html'" style="height: 60px; font-weight: bold;">
          üõí Open POS
      </button>
      <button class="btn" onclick="location.href='inventory.html'" style="height: 60px; font-weight: bold;">
          üì¶ Inventory
      </button>
      <button class="btn" onclick="location.href='sales.html'" style="height: 60px; font-weight: bold;">
          üìä Sales Report
      </button>
      <button class="btn" onclick="location.href='admin.html'" style="height: 60px; font-weight: bold;">
          ‚öôÔ∏è Admin
      </button>
      
      <button class="btn" onclick="sessionStorage.clear(); location.href='login.html'" 
              style="grid-column: span 2; height: 45px; background: #d32f2f; color: white; margin-top: 5px;">
          Logout
      </button>
  </div>
</section>
  </div>
    </section>
  </div>
</main>

<script src="js/database.js"></script>
<script>
    let mySalesChart;

    document.addEventListener("DOMContentLoaded", () => {
        // 1. Setup User Tag
        const name = sessionStorage.getItem("userName") || "Unknown";
        const role = sessionStorage.getItem("userRole") || "Staff";
        document.getElementById("displayUserName").innerText = name;
        document.getElementById("displayUserRole").innerText = role;

        // 2. Set Default Dates (Last 7 Days)
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - 6);
        
        document.getElementById('dashStart').value = start.toISOString().split('T')[0];
        document.getElementById('dashEnd').value = end.toISOString().split('T')[0];

        // 3. Initialize Chart and Data
        initChart();
        refreshDashboardData();
    });

    function initChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        mySalesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sales (‚Ç±)',
                    data: [],
                    borderColor: '#4a148c',
                    backgroundColor: 'rgba(74, 20, 140, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function refreshDashboardData() {
        const startVal = document.getElementById("dashStart").value;
        const endVal = document.getElementById("dashEnd").value;

        if (!startVal || !endVal) return;

        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        endDate.setHours(23, 59, 59, 999);

        // Update Labels
        document.getElementById("salesLabel").innerText = startDate.toDateString() === endDate.toDateString() ? "Daily Sales" : "Range Total Sales";

        // 1. Filter Sales Data
        const filtered = sales.filter(s => {
            const d = new Date(s.date);
            return d >= startDate && d <= endDate;
        });

        // 2. Update Stats Cards
        const totalRev = filtered.reduce((sum, s) => sum + (parseFloat(s.total) || 0), 0);
        document.getElementById("dashTotalSales").innerText = "‚Ç±" + totalRev.toFixed(2);
        document.getElementById("dashTotalCount").innerText = filtered.length;

        // 3. Process Chart Data (Group by Day)
        const dailyData = {};
        filtered.forEach(s => {
            const dayKey = new Date(s.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            dailyData[dayKey] = (dailyData[dayKey] || 0) + parseFloat(s.total);
        });

        mySalesChart.data.labels = Object.keys(dailyData);
        mySalesChart.data.datasets[0].data = Object.values(dailyData);
        mySalesChart.update();

        // 4. Update Stock Alerts (Static, not affected by date)
        const lowStockItems = products.filter(p => p.qty <= (config.lowStockThreshold || 5));
        document.getElementById("dashStockAlertCount").innerText = lowStockItems.length;
        
        const tableBody = document.getElementById("lowStockTable");
        tableBody.innerHTML = lowStockItems.length === 0 
            ? `<tr><td colspan="3" style="padding:20px; text-align:center; color:green;">‚úÖ Stock levels healthy.</td></tr>`
            : lowStockItems.map(p => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${p.name}</td>
                    <td style="color: red; font-weight: bold;">${p.qty}</td>
                    <td><span style="background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">Low</span></td>
                </tr>`).join('');
          // 5. Update Expiry Alerts (Raw Materials)
        const dashExpiryTable = document.getElementById("dashExpiryTable");
        if (dashExpiryTable) {
            const today = new Date();
            today.setHours(0,0,0,0);

            // Filter for items already expired OR expiring within 7 days
            const urgentExpiries = rawMaterials.filter(item => {
                const expDate = new Date(item.expiry);
                const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                return diffDays <= 7; // Show anything expiring in a week or less
            });

            // Sort by earliest expiry first
            urgentExpiries.sort((a, b) => new Date(a.expiry) - new Date(b.expiry));

            dashExpiryTable.innerHTML = urgentExpiries.length === 0 
                ? `<tr><td colspan="3" style="padding:20px; text-align:center; color:green;">‚úÖ All materials fresh.</td></tr>`
                : urgentExpiries.map(item => {
                    const expDate = new Date(item.expiry);
                    const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    
                    let badgeColor = "#2e7d32"; 
                    let badgeText = `${diffDays}d`;
                    let bgColor = "transparent";

                    if (diffDays < 0) {
                        badgeColor = "#d32f2f"; 
                        badgeText = "EXPIRED";
                        bgColor = "#fff1f0";
                    } else if (diffDays <= 3) {
                        badgeColor = "#f57c00"; 
                        badgeText = "URGENT";
                    }

                    return `
                        <tr style="border-bottom: 1px solid #eee; background: ${bgColor}">
                            <td style="padding: 10px;"><strong>${item.name}</strong></td>
                            <td style="font-size: 0.8rem;">${item.expiry}</td>
                            <td>
                                <span style="color: white; background: ${badgeColor}; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">
                                    ${badgeText}
                                </span>
                            </td>
                        </tr>`;
                }).join('');
        }

    }

    function setDashQuickDate(range) {
    const startInput = document.getElementById("dashStart");
    const endInput = document.getElementById("dashEnd");
    const now = new Date();
    let start = new Date();
    let end = new Date();

    if (range === 'today') { /* Use default start/end */ } 
    else if (range === 'week') {
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        start.setDate(diff);
    } 
    else if (range === 'month') {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    }

    startInput.value = start.toISOString().split('T')[0];
    endInput.value = end.toISOString().split('T')[0];
    refreshDashboardData(); // Automatically refresh graph and cards
}
</script>
</body>
</html>